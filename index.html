<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Offsite Medical Visit</title>
  <style>
    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 16px; max-width: 820px; }
    h1 { margin: 0 0 12px 0; font-size: 20px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    label { display:block; font-weight:600; margin-top:10px; }
    input, textarea, select { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; font-size:16px; }
    textarea{ min-height:100px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .actions { display:flex; flex-wrap:wrap; gap:8px; margin-top:14px; }
    button { border:1px solid #ccc; background:#f7f7f7; border-radius:10px; padding:10px 12px; font-size:16px; }
    button:active { transform: translateY(1px); }
    .muted { color:#666; font-size:14px; margin-top:8px; }
    .ok { color: #0a7; }
    .danger { color: #b00; }
    @media print {
      .actions, .muted { display:none; }
      body { margin: 0; }
      .card { border:none; }
    }
  </style>
</head>
<body>
  <h1>Offsite Medical Visit</h1>
  <div class="card">
    <form id="visit-form" autocomplete="on">
      <label>ID (auto): <input id="id" name="id" placeholder="MV-YYYY-####" readonly></label>

      <div class="row">
        <label>Date* <input id="date" name="date" type="date" required></label>
        <label>Time* <input id="time" name="time" type="time" required></label>
      </div>

      <label>Location (Site / Area)* <input id="location" name="location" required></label>
      <label>Supervisor (HSE)* <input id="supervisor" name="supervisor" required></label>
      <label>Craft* <input id="craft" name="craft" required></label>
      <label>Facility (Clinic / Hospital)* <input id="facility" name="facility" required></label>
      <label>Notes (optional) <textarea id="notes" name="notes" placeholder="Details, treatment, transportation, follow-upâ€¦"></textarea></label>

      <div class="actions">
        <button type="button" id="saveBtn">Save</button>
        <button type="button" id="shareBtn">Share</button>
        <button type="button" id="printBtn">Print / PDF</button>
        <button type="button" id="dupBtn">Duplicate</button>
        <button type="button" id="dlJsonBtn">Download .json</button>
        <button type="button" id="dlCsvBtn">Download All .csv</button>
        <label style="border:1px dashed #bbb; padding:8px 12px; border-radius:10px; display:inline-block;">
          Upload (.json) <input type="file" id="upload" accept=".json,application/json" style="display:none">
        </label>
        <button type="button" id="newBtn">New</button>
        <button type="button" id="wipeBtn">Wipe Local</button>
      </div>

      <div class="muted">Saved: <span id="count">0</span></div>
      <div class="muted" id="msg"></div>
    </form>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const KEY = 'medical_offsite_visits_v1';

    const now = new Date();
    $('date').valueAsDate = now;
    $('time').value = now.toTimeString().slice(0,5);

    function loadAll() {
      try { return JSON.parse(localStorage.getItem(KEY)) || []; }
      catch { return []; }
    }
    function saveAll(arr) { localStorage.setItem(KEY, JSON.stringify(arr)); }
    function updateCount() { $('count').textContent = loadAll().length; }

    function pad(n){ return String(n).padStart(4, '0'); }
    function year(d){ return String(d.getFullYear()); }

    function nextId() {
      const arr = loadAll();
      const y = year(new Date());
      let max = 0;
      for (const r of arr) {
        const m = /^MV-(\d{4})-(\d{4})$/.exec(r.id || '');
        if (m && m[1] === y) max = Math.max(max, parseInt(m[2],10));
      }
      return `MV-${y}-${pad(max+1)}`;
    }

    function formToObj() {
      return {
        id: $('id').value || nextId(),
        date: $('date').value,
        time: $('time').value,
        location: $('location').value.trim(),
        supervisor: $('supervisor').value.trim(),
        craft: $('craft').value.trim(),
        facility: $('facility').value.trim(),
        notes: $('notes').value.trim(),
        createdAt: new Date().toISOString()
      };
    }

    function objToForm(o) {
      $('id').value = o.id || '';
      $('date').value = o.date || '';
      $('time').value = o.time || '';
      $('location').value = o.location || '';
      $('supervisor').value = o.supervisor || '';
      $('craft').value = o.craft || '';
      $('facility').value = o.facility || '';
      $('notes').value = o.notes || '';
    }

    function setMsg(txt, cls='ok') {
      const el = $('msg'); el.className = cls; el.textContent = txt;
      setTimeout(()=>{ el.textContent=''; }, 2000);
    }

    function requireFields() {
      for (const id of ['date','time','location','supervisor','craft','facility']) {
        if (!$(id).value) { $(id).focus(); setMsg('Missing required fields', 'danger'); return false; }
      }
      return true;
    }

    function download(filename, text) {
      const blob = new Blob([text], {type: 'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    function toCSV(rows) {
      const headers = ['id','date','time','location','supervisor','craft','facility','notes','createdAt'];
      const esc = s => `"${String(s ?? '').replace(/"/g,'""')}"`;
      const lines = [headers.join(',')];
      for (const r of rows) lines.push(headers.map(h => esc(r[h])).join(','));
      return lines.join('\n');
    }

    // init ID and counter
    $('id').value = nextId();
    updateCount();

    // actions
    $('saveBtn').onclick = () => {
      if (!requireFields()) return;
      const arr = loadAll();
      const rec = formToObj();
      // prevent duplicates of same ID
      const i = arr.findIndex(x => x.id === rec.id);
      if (i >= 0) arr[i] = rec; else arr.push(rec);
      saveAll(arr); updateCount(); setMsg('Saved');
    };

    $('shareBtn').onclick = async () => {
      if (!requireFields()) return;
      const rec = formToObj();
      const text =
`Offsite Medical Visit ${rec.id}
Date/Time: ${rec.date} ${rec.time}
Location: ${rec.location}
Supervisor: ${rec.supervisor}
Craft: ${rec.craft}
Facility: ${rec.facility}
Notes: ${rec.notes || '-'}
`;
      if (navigator.share) {
        try { await navigator.share({title: rec.id, text}); setMsg('Shared'); }
        catch(e){ setMsg('Share canceled','danger'); }
      } else {
        await navigator.clipboard.writeText(text);
        setMsg('Copied to clipboard');
      }
    };

    $('printBtn').onclick = () => window.print();

    $('dupBtn').onclick = () => {
      $('id').value = nextId();
      setMsg('Duplicated (new ID)');
    };

    $('dlJsonBtn').onclick = () => {
      const rec = formToObj();
      download(`${rec.id}.json`, JSON.stringify(rec, null, 2));
    };

    $('dlCsvBtn').onclick = () => {
      const rows = loadAll();
      if (!rows.length) { setMsg('Nothing saved yet','danger'); return; }
      download('medical-offsite-all.csv', toCSV(rows));
    };

    $('upload').onchange = async (e) => {
      const f = e.target.files[0]; if (!f) return;
      const text = await f.text();
      try {
        const parsed = JSON.parse(text);
        const arr = loadAll();
        if (Array.isArray(parsed)) arr.push(...parsed);
        else arr.push(parsed);
        saveAll(arr); updateCount(); setMsg('Import complete');
      } catch {
        setMsg('Bad JSON file', 'danger');
      }
      e.target.value = '';
    };

    $('newBtn').onclick = () => {
      objToForm({ id: nextId(), date: $('date').value, time: $('time').value });
      $('location').value = $('supervisor').value = $('craft').value = $('facility').value = '';
      $('notes').value = '';
      setMsg('New entry');
    };

    $('wipeBtn').onclick = () => {
      if (confirm('Delete all saved entries on this device?')) {
        localStorage.removeItem(KEY);
        updateCount(); setMsg('Local data wiped','danger');
      }
    };
  </script>
</body>
</html>
